# Woodpecker-CI
# 
# Um den Docker Container fuer build ('openems-build') zu aktualisieren:
# - ssh auf gitvm
# - cd /root/fems/tools
# - git pull
# - bash drone-docker.sh

variables:
  - &sftp-settings
    server: 10.0.0.40
    username: user
    password: pass
    ignore_branch: true
    port: 2222
    path: /cache
    mount:
      - cache

  - &when
    when:
      - branch: [main, develop]
      - path: 
          include: [ 'io.openems*/**', '**/*gradle*', '.woodpecker/java-build.yml' ]

clone:
  git:
    <<: *when
    image: woodpeckerci/plugin-git

steps:
  restore-cache:
    <<: *when
    image: appleboy/drone-sftp-cache
    settings:
      restore: true
      <<: *sftp-settings

  build-java:
    <<: *when
    image: openems-build:latest
    commands:
      - export CACHE=$CI_WORKSPACE/cache
      - mkdir -p $CACHE
      - export GRADLE_USER_HOME=$CACHE/gradle
      - export MAVEN_OPTS=-Dmaven.repo.local=$CACHE/maven
      - ./gradlew --build-cache build buildEdge buildBackend resolve.EdgeApp resolve.BackendApp --parallel --max-workers=4 
      - git diff --exit-code io.openems.edge.application/EdgeApp.bndrun io.openems.backend.application/BackendApp.bndrun

  rebuild-cache:
    <<: *when
    image: appleboy/drone-sftp-cache
    settings:
      rebuild: true
      <<: *sftp-settings