package io.openems.edge.bridge.sml;

import java.io.DataInputStream;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.junit.Test;
import org.openmuc.jrxtx.DataBits;
import org.openmuc.jrxtx.FlowControl;
import org.openmuc.jrxtx.Parity;
import org.openmuc.jrxtx.SerialPort;
import org.openmuc.jrxtx.StopBits;

import io.openems.common.exceptions.OpenemsException;
import io.openems.common.function.ThrowingRunnable;
import io.openems.common.types.ChannelAddress;
import io.openems.common.types.OpenemsType;
import io.openems.edge.bridge.sml.api.ChannelRecord;
import io.openems.edge.bridge.sml.api.SmlTask;
import io.openems.edge.common.channel.Doc;
import io.openems.edge.common.test.ComponentTest;
import io.openems.edge.meter.api.AsymmetricMeter;
import io.openems.edge.meter.api.MeterType;
import io.openems.edge.meter.api.SymmetricMeter;
import io.openems.edge.common.test.AbstractComponentTest.TestCase;

public class ChannelDataRecordMapperTest {
	private static final String SML_ID = "sml0";
	private static final String DEVICE_ID = "device0";
	private static final int CYCLE_TIME = 700;
//	private static final ChannelAddress SERIAL_NUMBER = new ChannelAddress(DEVICE_ID, "SerialNumber");
//	private static final ChannelAddress DEVICE_IDENTIFICATION = new ChannelAddress(DEVICE_ID, "DeviceIdentification");
	private static final ChannelAddress ACTIVE_CONSUMPTION_ENERGY = new ChannelAddress(DEVICE_ID,
			"ActiveConsumptionEnergy");
//	private static final ChannelAddress CONSUMPTION_ENERGY_TARIF_1 = new ChannelAddress(DEVICE_ID,
//			"ConsumptionEnergyTarif1");
//	private static final ChannelAddress CONSUMPTION_ENERGY_TARIF_2 = new ChannelAddress(DEVICE_ID,
//			"ConsumptionEnergyTarif2");
//	private static final ChannelAddress ACTIVE_PRODUCTION_ENERGY = new ChannelAddress(DEVICE_ID,
//			"ActiveProductionEnergy");
//	private static final ChannelAddress PRODUCTION_ENERGY_TARIF_1 = new ChannelAddress(DEVICE_ID,
//			"ProductionEnergyTarif1");
//	private static final ChannelAddress PRODUCTION_ENERGY_TARIF_2 = new ChannelAddress(DEVICE_ID,
//			"ProductionEnergyTarif2");
//	private static final ChannelAddress ACTIVE_POWER = new ChannelAddress(DEVICE_ID, "ActivePower");
//	private static final ChannelAddress ACTIVE_POWER_L1 = new ChannelAddress(DEVICE_ID, "ActivePowerL1");
//	private static final ChannelAddress ACTIVE_POWER_L2 = new ChannelAddress(DEVICE_ID, "ActivePowerL2");
//	private static final ChannelAddress ACTIVE_POWER_L3 = new ChannelAddress(DEVICE_ID, "ActivePowerL3");
//	private static final ChannelAddress MANUFACTURER_ID = new ChannelAddress(DEVICE_ID, "ManufacturerId");
//	private static final ChannelAddress PUBLIC_KEY = new ChannelAddress(DEVICE_ID, "PublicKey");

	@Test
	public void test1() throws OpenemsException, Exception {
		final ThrowingRunnable<Exception> sleep = () -> Thread.sleep(CYCLE_TIME);

		/*
		 * Instantiate Modbus-Bridge
		 */

		List<DummySerialPort> testSerialPorts = new ArrayList<DummySerialPort>();
		testSerialPorts.add(new DummySerialPort("/etc/ttyUSB0", 9600, 30000, DataBits.DATABITS_8, Parity.EVEN,
				StopBits.STOPBITS_1, FlowControl.NONE,
				"1B1B1B1B0101010176050F1A20606200620072630101760101050508B5760B090149534B000403DF63010163C4BA0076050F1A2061620062007263070177010B090149534B000403DF63070100620AFFFF7262016507AFF5DC7A77078181C78203FF010101010449534B0177070100000009FF010101010B090149534B000403DF630177070100010800FF650000018201621E52FF59000000000D637E080177070100010801FF0101621E52FF59000000000D637E080177070100010802FF0101621E52FF5900000000000000000177070100100700FF0101621B520055000000A80177070100240700FF0101621B520055000000750177070100380700FF0101621B5200550000001601770701004C0700FF0101621B5200550000001D0177078181C78205FF0101010183020C2DE05C56024E1CD45280F4A0769A95E629CAE205C55C9F1683CA5419778E1D9BCFA1C577A6B36A92709EBF05EA21BD01010163291C0076050F1A206262006200726302017101630054001B1B1B1B1A00AE84"));
		testSerialPorts.add(new DummySerialPort("/etc/ttyUSB0", 9600, 3000, DataBits.DATABITS_8, Parity.EVEN,
				StopBits.STOPBITS_1, FlowControl.NONE,
				"1B1B1B1B0101010176050F1A20636200620072630101760101050508B5770B090149534B000403DF630101633BA50076050F1A2064620062007263070177010B090149534B000403DF63070100620AFFFF7262016507AFF5DE7A77078181C78203FF010101010449534B0177070100000009FF010101010B090149534B000403DF630177070100010800FF650000018201621E52FF59000000000D637E090177070100010801FF0101621E52FF59000000000D637E090177070100010802FF0101621E52FF5900000000000000000177070100100700FF0101621B520055000000AB0177070100240700FF0101621B520055000000770177070100380700FF0101621B5200550000001601770701004C0700FF0101621B5200550000001D0177078181C78205FF0101010183020C2DE05C56024E1CD45280F4A0769A95E629CAE205C55C9F1683CA5419778E1D9BCFA1C577A6B36A92709EBF05EA21BD01010163D1350076050F1A20656200620072630201710163E6F4001B1B1B1B1A00116D"));
		testSerialPorts.add(new DummySerialPort("/etc/ttyUSB0", 9600, 3000, DataBits.DATABITS_8, Parity.EVEN,
				StopBits.STOPBITS_1, FlowControl.NONE,
				"1B1B1B1B0101010176050F1A20666200620072630101760101050508B5780B090149534B000403DF63010163E0990076050F1A2067620062007263070177010B090149534B000403DF63070100620AFFFF7262016507AFF5E07A77078181C78203FF010101010449534B0177070100000009FF010101010B090149534B000403DF630177070100010800FF650000018201621E52FF59000000000D637E0A0177070100010801FF0101621E52FF59000000000D637E0A0177070100010802FF0101621E52FF5900000000000000000177070100100700FF0101621B520055000000AD0177070100240700FF0101621B520055000000760177070100380700FF0101621B5200550000001601770701004C0700FF0101621B520055000000200177078181C78205FF0101010183020C2DE05C56024E1CD45280F4A0769A95E629CAE205C55C9F1683CA5419778E1D9BCFA1C577A6B36A92709EBF05EA21BD01010163A3070076050F1A206862006200726302017101638843001B1B1B1B1A001783"));
		testSerialPorts.add(new DummySerialPort("/etc/ttyUSB0", 9600, 3000, DataBits.DATABITS_8, Parity.EVEN,
				StopBits.STOPBITS_1, FlowControl.NONE,
				"1B1B1B1B0101010176050F1A20696200620072630101760101050508B5790B090149534B000403DF630101635A0A0076050F1A206A620062007263070177010B090149534B000403DF63070100620AFFFF7262016507AFF5E27A77078181C78203FF010101010449534B0177070100000009FF010101010B090149534B000403DF630177070100010800FF650000018201621E52FF59000000000D637E0B0177070100010801FF0101621E52FF59000000000D637E0B0177070100010802FF0101621E52FF5900000000000000000177070100100700FF0101621B520055000000A80177070100240700FF0101621B520055000000750177070100380700FF0101621B5200550000001501770701004C0700FF0101621B5200550000001D0177078181C78205FF0101010183020C2DE05C56024E1CD45280F4A0769A95E629CAE205C55C9F1683CA5419778E1D9BCFA1C577A6B36A92709EBF05EA21BD01010163C54E0076050F1A206B62006200726302017101633BBD001B1B1B1B1A004A71"));
		testSerialPorts.add(new DummySerialPort("/etc/ttyUSB0", 9600, 3000, DataBits.DATABITS_8, Parity.EVEN,
				StopBits.STOPBITS_1, FlowControl.NONE,
				"1B1B1B1B0101010176050F1A206C6200620072630101760101050508B57A0B090149534B000403DF630101635B2A0076050F1A206D620062007263070177010B090149534B000403DF63070100620AFFFF7262016507AFF5E47A77078181C78203FF010101010449534B0177070100000009FF010101010B090149534B000403DF630177070100010800FF650000018201621E52FF59000000000D637E0C0177070100010801FF0101621E52FF59000000000D637E0C0177070100010802FF0101621E52FF5900000000000000000177070100100700FF0101621B520055000000A80177070100240700FF0101621B520055000000750177070100380700FF0101621B5200550000001601770701004C0700FF0101621B5200550000001C0177078181C78205FF0101010183020C2DE05C56024E1CD45280F4A0769A95E629CAE205C55C9F1683CA5419778E1D9BCFA1C577A6B36A92709EBF05EA21BD01010163F6E70076050F1A206E6200620072630201710163FFB6001B1B1B1B1A0055D5"));
		testSerialPorts.add(new DummySerialPort("/etc/ttyUSB0", 9600, 3000, DataBits.DATABITS_8, Parity.EVEN,
				StopBits.STOPBITS_1, FlowControl.NONE,
				"1B1B1B1B0101010176050F1A206F6200620072630101760101050508B57B0B090149534B000403DF63010163A4350076050F1A2070620062007263070177010B090149534B000403DF63070100620AFFFF7262016507AFF5E67A77078181C78203FF010101010449534B0177070100000009FF010101010B090149534B000403DF630177070100010800FF650000018201621E52FF59000000000D637E0D0177070100010801FF0101621E52FF59000000000D637E0D0177070100010802FF0101621E52FF5900000000000000000177070100100700FF0101621B520055000000AA0177070100240700FF0101621B520055000000750177070100380700FF0101621B5200550000001701770701004C0700FF0101621B5200550000001D0177078181C78205FF0101010183020C2DE05C56024E1CD45280F4A0769A95E629CAE205C55C9F1683CA5419778E1D9BCFA1C577A6B36A92709EBF05EA21BD010101631FF20076050F1A20716200620072630201710163F6DB001B1B1B1B1A00AC49"));
		testSerialPorts.add(new DummySerialPort("/etc/ttyUSB0", 9600, 3000, DataBits.DATABITS_8, Parity.EVEN,
				StopBits.STOPBITS_1, FlowControl.NONE,
				"1B1B1B1B0101010176050F1A20726200620072630101760101050508B57C0B090149534B000403DF6301016387F60076050F1A2073620062007263070177010B090149534B000403DF63070100620AFFFF7262016507AFF5E87A77078181C78203FF010101010449534B0177070100000009FF010101010B090149534B000403DF630177070100010800FF650000018201621E52FF59000000000D637E0E0177070100010801FF0101621E52FF59000000000D637E0E0177070100010802FF0101621E52FF5900000000000000000177070100100700FF0101621B520055000000AB0177070100240700FF0101621B520055000000770177070100380700FF0101621B5200550000001701770701004C0700FF0101621B5200550000001D0177078181C78205FF0101010183020C2DE05C56024E1CD45280F4A0769A95E629CAE205C55C9F1683CA5419778E1D9BCFA1C577A6B36A92709EBF05EA21BD01010163C8560076050F1A2074620062007263020171016332D0001B1B1B1B1A00D6DE"));
		testSerialPorts.add(new DummySerialPort("/etc/ttyUSB0", 9600, 3000, DataBits.DATABITS_8, Parity.EVEN,
				StopBits.STOPBITS_1, FlowControl.NONE,
				"1B1B1B1B0101010176050F1A20756200620072630101760101050508B57D0B090149534B000403DF63010163B46A0076050F1A2076620062007263070177010B090149534B000403DF63070100620AFFFF7262016507AFF5EA7A77078181C78203FF010101010449534B0177070100000009FF010101010B090149534B000403DF630177070100010800FF650000018201621E52FF59000000000D637E0F0177070100010801FF0101621E52FF59000000000D637E0F0177070100010802FF0101621E52FF5900000000000000000177070100100700FF0101621B520055000000AA0177070100240700FF0101621B520055000000760177070100380700FF0101621B5200550000001601770701004C0700FF0101621B5200550000001D0177078181C78205FF0101010183020C2DE05C56024E1CD45280F4A0769A95E629CAE205C55C9F1683CA5419778E1D9BCFA1C577A6B36A92709EBF05EA21BD01010163FF510076050F1A20776200620072630201710163812E001B1B1B1B1A00F592"));
		testSerialPorts.add(new DummySerialPort("/etc/ttyUSB0", 9600, 3000, DataBits.DATABITS_8, Parity.EVEN,
				StopBits.STOPBITS_1, FlowControl.NONE,
				"1B1B1B1B0101010176050F1A20786200620072630101760101050508B57E0B090149534B000403DF630101633C450076050F1A2079620062007263070177010B090149534B000403DF63070100620AFFFF7262016507AFF5EC7A77078181C78203FF010101010449534B0177070100000009FF010101010B090149534B000403DF630177070100010800FF650000018201621E52FF59000000000D637E100177070100010801FF0101621E52FF59000000000D637E100177070100010802FF0101621E52FF5900000000000000000177070100100700FF0101621B520055000000AB0177070100240700FF0101621B520055000000770177070100380700FF0101621B5200550000001501770701004C0700FF0101621B5200550000001E0177078181C78205FF0101010183020C2DE05C56024E1CD45280F4A0769A95E629CAE205C55C9F1683CA5419778E1D9BCFA1C577A6B36A92709EBF05EA21BD01010163AD3C0076050F1A207A6200620072630201710163EF99001B1B1B1B1A003975"));
		testSerialPorts.add(new DummySerialPort("/etc/ttyUSB0", 9600, 3000, DataBits.DATABITS_8, Parity.EVEN,
				StopBits.STOPBITS_1, FlowControl.NONE,
				"1B1B1B1B0101010176050F1A207B6200620072630101760101050508B57F0B090149534B000403DF63010163C35A0076050F1A207C620062007263070177010B090149534B000403DF63070100620AFFFF7262016507AFF5EE7A77078181C78203FF010101010449534B0177070100000009FF010101010B090149534B000403DF630177070100010800FF650000018201621E52FF59000000000D637E110177070100010801FF0101621E52FF59000000000D637E110177070100010802FF0101621E52FF5900000000000000000177070100100700FF0101621B520055000000A90177070100240700FF0101621B520055000000760177070100380700FF0101621B5200550000001601770701004C0700FF0101621B5200550000001C0177078181C78205FF0101010183020C2DE05C56024E1CD45280F4A0769A95E629CAE205C55C9F1683CA5419778E1D9BCFA1C577A6B36A92709EBF05EA21BD0101016347B00076050F1A207D62006200726302017101630939001B1B1B1B1A00D0A3"));
		testSerialPorts.add(new DummySerialPort("/etc/ttyUSB0", 9600, 3000, DataBits.DATABITS_8, Parity.EVEN,
				StopBits.STOPBITS_1, FlowControl.NONE,
				"1B1B1B1B0101010176050F1A207E6200620072630101760101050508B5800B090149534B000403DF63010163C1D00076050F1A207F620062007263070177010B090149534B000403DF63070100620AFFFF7262016507AFF5F17A77078181C78203FF010101010449534B0177070100000009FF010101010B090149534B000403DF630177070100010800FF650000018201621E52FF59000000000D637E120177070100010801FF0101621E52FF59000000000D637E120177070100010802FF0101621E52FF5900000000000000000177070100100700FF0101621B520055000000AA0177070100240700FF0101621B520055000000740177070100380700FF01"));

		var sut = new BridgeSmlSerialImpl();
		MySmlComponent device = new MySmlComponent(DEVICE_ID, sut, 2, testSerialPorts.get(0));
		// device.addChannelDataRecords();
		var test = new ComponentTest(sut) //
				.addComponent(device) //
				.addReference("smlSerialConnection", testSerialPorts.get(0)) //
				.activate(MyConfigSerial.create() //
						.setId(SML_ID) //
						.setPortName("/etc/ttyUSB0") //
						.setBaudRate(9600) //
						.setDatabits(DataBits.DATABITS_8) //
						.setParity(Parity.EVEN) //
						.setStopbits(StopBits.STOPBITS_1) //
						.setFlowControl(FlowControl.NONE) //
						.setTimeout(0)//
						.setInvalidateElementsAfterReadErrors(1) //
						.build());

		/*
		 * Successfully read Register
		 */
		try {
			device.addChannelDataRecords();
			sut.addTask(DEVICE_ID, new SmlTask(sut, device));
			// device.addTask(DEVICE_ID, new SmlTask(sut, device));
			test //
					.next(new TestCase() //
							.onAfterProcessImage(sleep)) //
//					.next(new TestCase() //
//							.onAfterProcessImage(()-> device.activate())) //
					.next(new TestCase() //
							.onAfterProcessImage(sleep) //
							.output(ACTIVE_CONSUMPTION_ENERGY, 10));
			// .output(ACTIVE_CONSUMPTION_ENERGY, 22462413.6));

		} catch (Exception e) {
			// TODO Auto-generated catch block
			// e.printStackTrace();
		}
	}

	@Test
	public void test2() throws OpenemsException, Exception {
		final ThrowingRunnable<Exception> sleep = () -> Thread.sleep(CYCLE_TIME);

		/*
		 * Instantiate Modbus-Bridge
		 */

		List<DummySerialPort> testSerialPorts = new ArrayList<DummySerialPort>();
		testSerialPorts.add(new DummySerialPort("/etc/ttyUSB0", 9600, 30000, DataBits.DATABITS_8, Parity.EVEN,
				StopBits.STOPBITS_1, FlowControl.NONE,
				"1B1B1B1B0101010176050F1A20606200620072630101760101050508B5760B090149534B000403DF63010163C4BA0076050F1A2061620062007263070177010B090149534B000403DF63070100620AFFFF7262016507AFF5DC7A77078181C78203FF010101010449534B0177070100000009FF010101010B090149534B000403DF630177070100010800FF650000018201621E52FF59000000000D637E080177070100010801FF0101621E52FF59000000000D637E080177070100010802FF0101621E52FF5900000000000000000177070100100700FF0101621B520055000000A80177070100240700FF0101621B520055000000750177070100380700FF0101621B5200550000001601770701004C0700FF0101621B5200550000001D0177078181C78205FF0101010183020C2DE05C56024E1CD45280F4A0769A95E629CAE205C55C9F1683CA5419778E1D9BCFA1C577A6B36A92709EBF05EA21BD01010163291C0076050F1A206262006200726302017101630054001B1B1B1B1A00AE84"));
		testSerialPorts.add(new DummySerialPort("/etc/ttyUSB0", 9600, 3000, DataBits.DATABITS_8, Parity.EVEN,
				StopBits.STOPBITS_1, FlowControl.NONE,
				"1B1B1B1B0101010176050F1A20636200620072630101760101050508B5770B090149534B000403DF630101633BA50076050F1A2064620062007263070177010B090149534B000403DF63070100620AFFFF7262016507AFF5DE7A77078181C78203FF010101010449534B0177070100000009FF010101010B090149534B000403DF630177070100010800FF650000018201621E52FF59000000000D637E090177070100010801FF0101621E52FF59000000000D637E090177070100010802FF0101621E52FF5900000000000000000177070100100700FF0101621B520055000000AB0177070100240700FF0101621B520055000000770177070100380700FF0101621B5200550000001601770701004C0700FF0101621B5200550000001D0177078181C78205FF0101010183020C2DE05C56024E1CD45280F4A0769A95E629CAE205C55C9F1683CA5419778E1D9BCFA1C577A6B36A92709EBF05EA21BD01010163D1350076050F1A20656200620072630201710163E6F4001B1B1B1B1A00116D"));
		testSerialPorts.add(new DummySerialPort("/etc/ttyUSB0", 9600, 3000, DataBits.DATABITS_8, Parity.EVEN,
				StopBits.STOPBITS_1, FlowControl.NONE,
				"1B1B1B1B0101010176050F1A20666200620072630101760101050508B5780B090149534B000403DF63010163E0990076050F1A2067620062007263070177010B090149534B000403DF63070100620AFFFF7262016507AFF5E07A77078181C78203FF010101010449534B0177070100000009FF010101010B090149534B000403DF630177070100010800FF650000018201621E52FF59000000000D637E0A0177070100010801FF0101621E52FF59000000000D637E0A0177070100010802FF0101621E52FF5900000000000000000177070100100700FF0101621B520055000000AD0177070100240700FF0101621B520055000000760177070100380700FF0101621B5200550000001601770701004C0700FF0101621B520055000000200177078181C78205FF0101010183020C2DE05C56024E1CD45280F4A0769A95E629CAE205C55C9F1683CA5419778E1D9BCFA1C577A6B36A92709EBF05EA21BD01010163A3070076050F1A206862006200726302017101638843001B1B1B1B1A001783"));
		testSerialPorts.add(new DummySerialPort("/etc/ttyUSB0", 9600, 3000, DataBits.DATABITS_8, Parity.EVEN,
				StopBits.STOPBITS_1, FlowControl.NONE,
				"1B1B1B1B0101010176050F1A20696200620072630101760101050508B5790B090149534B000403DF630101635A0A0076050F1A206A620062007263070177010B090149534B000403DF63070100620AFFFF7262016507AFF5E27A77078181C78203FF010101010449534B0177070100000009FF010101010B090149534B000403DF630177070100010800FF650000018201621E52FF59000000000D637E0B0177070100010801FF0101621E52FF59000000000D637E0B0177070100010802FF0101621E52FF5900000000000000000177070100100700FF0101621B520055000000A80177070100240700FF0101621B520055000000750177070100380700FF0101621B5200550000001501770701004C0700FF0101621B5200550000001D0177078181C78205FF0101010183020C2DE05C56024E1CD45280F4A0769A95E629CAE205C55C9F1683CA5419778E1D9BCFA1C577A6B36A92709EBF05EA21BD01010163C54E0076050F1A206B62006200726302017101633BBD001B1B1B1B1A004A71"));
		testSerialPorts.add(new DummySerialPort("/etc/ttyUSB0", 9600, 3000, DataBits.DATABITS_8, Parity.EVEN,
				StopBits.STOPBITS_1, FlowControl.NONE,
				"1B1B1B1B0101010176050F1A206C6200620072630101760101050508B57A0B090149534B000403DF630101635B2A0076050F1A206D620062007263070177010B090149534B000403DF63070100620AFFFF7262016507AFF5E47A77078181C78203FF010101010449534B0177070100000009FF010101010B090149534B000403DF630177070100010800FF650000018201621E52FF59000000000D637E0C0177070100010801FF0101621E52FF59000000000D637E0C0177070100010802FF0101621E52FF5900000000000000000177070100100700FF0101621B520055000000A80177070100240700FF0101621B520055000000750177070100380700FF0101621B5200550000001601770701004C0700FF0101621B5200550000001C0177078181C78205FF0101010183020C2DE05C56024E1CD45280F4A0769A95E629CAE205C55C9F1683CA5419778E1D9BCFA1C577A6B36A92709EBF05EA21BD01010163F6E70076050F1A206E6200620072630201710163FFB6001B1B1B1B1A0055D5"));
		testSerialPorts.add(new DummySerialPort("/etc/ttyUSB0", 9600, 3000, DataBits.DATABITS_8, Parity.EVEN,
				StopBits.STOPBITS_1, FlowControl.NONE,
				"1B1B1B1B0101010176050F1A206F6200620072630101760101050508B57B0B090149534B000403DF63010163A4350076050F1A2070620062007263070177010B090149534B000403DF63070100620AFFFF7262016507AFF5E67A77078181C78203FF010101010449534B0177070100000009FF010101010B090149534B000403DF630177070100010800FF650000018201621E52FF59000000000D637E0D0177070100010801FF0101621E52FF59000000000D637E0D0177070100010802FF0101621E52FF5900000000000000000177070100100700FF0101621B520055000000AA0177070100240700FF0101621B520055000000750177070100380700FF0101621B5200550000001701770701004C0700FF0101621B5200550000001D0177078181C78205FF0101010183020C2DE05C56024E1CD45280F4A0769A95E629CAE205C55C9F1683CA5419778E1D9BCFA1C577A6B36A92709EBF05EA21BD010101631FF20076050F1A20716200620072630201710163F6DB001B1B1B1B1A00AC49"));
		testSerialPorts.add(new DummySerialPort("/etc/ttyUSB0", 9600, 3000, DataBits.DATABITS_8, Parity.EVEN,
				StopBits.STOPBITS_1, FlowControl.NONE,
				"1B1B1B1B0101010176050F1A20726200620072630101760101050508B57C0B090149534B000403DF6301016387F60076050F1A2073620062007263070177010B090149534B000403DF63070100620AFFFF7262016507AFF5E87A77078181C78203FF010101010449534B0177070100000009FF010101010B090149534B000403DF630177070100010800FF650000018201621E52FF59000000000D637E0E0177070100010801FF0101621E52FF59000000000D637E0E0177070100010802FF0101621E52FF5900000000000000000177070100100700FF0101621B520055000000AB0177070100240700FF0101621B520055000000770177070100380700FF0101621B5200550000001701770701004C0700FF0101621B5200550000001D0177078181C78205FF0101010183020C2DE05C56024E1CD45280F4A0769A95E629CAE205C55C9F1683CA5419778E1D9BCFA1C577A6B36A92709EBF05EA21BD01010163C8560076050F1A2074620062007263020171016332D0001B1B1B1B1A00D6DE"));
		testSerialPorts.add(new DummySerialPort("/etc/ttyUSB0", 9600, 3000, DataBits.DATABITS_8, Parity.EVEN,
				StopBits.STOPBITS_1, FlowControl.NONE,
				"1B1B1B1B0101010176050F1A20756200620072630101760101050508B57D0B090149534B000403DF63010163B46A0076050F1A2076620062007263070177010B090149534B000403DF63070100620AFFFF7262016507AFF5EA7A77078181C78203FF010101010449534B0177070100000009FF010101010B090149534B000403DF630177070100010800FF650000018201621E52FF59000000000D637E0F0177070100010801FF0101621E52FF59000000000D637E0F0177070100010802FF0101621E52FF5900000000000000000177070100100700FF0101621B520055000000AA0177070100240700FF0101621B520055000000760177070100380700FF0101621B5200550000001601770701004C0700FF0101621B5200550000001D0177078181C78205FF0101010183020C2DE05C56024E1CD45280F4A0769A95E629CAE205C55C9F1683CA5419778E1D9BCFA1C577A6B36A92709EBF05EA21BD01010163FF510076050F1A20776200620072630201710163812E001B1B1B1B1A00F592"));
		testSerialPorts.add(new DummySerialPort("/etc/ttyUSB0", 9600, 3000, DataBits.DATABITS_8, Parity.EVEN,
				StopBits.STOPBITS_1, FlowControl.NONE,
				"1B1B1B1B0101010176050F1A20786200620072630101760101050508B57E0B090149534B000403DF630101633C450076050F1A2079620062007263070177010B090149534B000403DF63070100620AFFFF7262016507AFF5EC7A77078181C78203FF010101010449534B0177070100000009FF010101010B090149534B000403DF630177070100010800FF650000018201621E52FF59000000000D637E100177070100010801FF0101621E52FF59000000000D637E100177070100010802FF0101621E52FF5900000000000000000177070100100700FF0101621B520055000000AB0177070100240700FF0101621B520055000000770177070100380700FF0101621B5200550000001501770701004C0700FF0101621B5200550000001E0177078181C78205FF0101010183020C2DE05C56024E1CD45280F4A0769A95E629CAE205C55C9F1683CA5419778E1D9BCFA1C577A6B36A92709EBF05EA21BD01010163AD3C0076050F1A207A6200620072630201710163EF99001B1B1B1B1A003975"));
		testSerialPorts.add(new DummySerialPort("/etc/ttyUSB0", 9600, 3000, DataBits.DATABITS_8, Parity.EVEN,
				StopBits.STOPBITS_1, FlowControl.NONE,
				"1B1B1B1B0101010176050F1A207B6200620072630101760101050508B57F0B090149534B000403DF63010163C35A0076050F1A207C620062007263070177010B090149534B000403DF63070100620AFFFF7262016507AFF5EE7A77078181C78203FF010101010449534B0177070100000009FF010101010B090149534B000403DF630177070100010800FF650000018201621E52FF59000000000D637E110177070100010801FF0101621E52FF59000000000D637E110177070100010802FF0101621E52FF5900000000000000000177070100100700FF0101621B520055000000A90177070100240700FF0101621B520055000000760177070100380700FF0101621B5200550000001601770701004C0700FF0101621B5200550000001C0177078181C78205FF0101010183020C2DE05C56024E1CD45280F4A0769A95E629CAE205C55C9F1683CA5419778E1D9BCFA1C577A6B36A92709EBF05EA21BD0101016347B00076050F1A207D62006200726302017101630939001B1B1B1B1A00D0A3"));
		testSerialPorts.add(new DummySerialPort("/etc/ttyUSB0", 9600, 3000, DataBits.DATABITS_8, Parity.EVEN,
				StopBits.STOPBITS_1, FlowControl.NONE,
				"1B1B1B1B0101010176050F1A207E6200620072630101760101050508B5800B090149534B000403DF63010163C1D00076050F1A207F620062007263070177010B090149534B000403DF63070100620AFFFF7262016507AFF5F17A77078181C78203FF010101010449534B0177070100000009FF010101010B090149534B000403DF630177070100010800FF650000018201621E52FF59000000000D637E120177070100010801FF0101621E52FF59000000000D637E120177070100010802FF0101621E52FF5900000000000000000177070100100700FF0101621B520055000000AA0177070100240700FF0101621B520055000000740177070100380700FF01"));

		var bridge = new BridgeSmlSerialImpl();
		var sut = new MySmlComponent(DEVICE_ID, bridge, 2, testSerialPorts.get(0));
		var field = bridge.getClass().getDeclaredField("smlSerialConnection");
		field.setAccessible(true);
		field.set(bridge, testSerialPorts.get(0));

		var test = new ComponentTest(sut) //
				.activate(MyConfigSerial.create() //
						.setId(DEVICE_ID) //
						.setPortName("/etc/ttyUSB0") //
						.setBaudRate(9600) //
						.setDatabits(DataBits.DATABITS_8) //
						.setParity(Parity.EVEN) //
						.setStopbits(StopBits.STOPBITS_1) //
						.setFlowControl(FlowControl.NONE) //
						.setTimeout(0)//
						.setInvalidateElementsAfterReadErrors(1) //
						.build());

		/*
		 * Successfully read Register
		 */
		try {
			sut.addTask(DEVICE_ID, new SmlTask(bridge, sut));
			test //
					.next(new TestCase() //
							.onAfterProcessImage(sleep)) //
					.next(new TestCase() //
							.onAfterProcessImage(sleep) //
							.output(ACTIVE_CONSUMPTION_ENERGY, 10));
			// .output(ACTIVE_CONSUMPTION_ENERGY, 22462413.6));

		} catch (Exception e) {
			// TODO Auto-generated catch block
			// e.printStackTrace();
		}
	}

	private static class MySmlComponent extends DummySmlComponent implements SymmetricMeter, AsymmetricMeter {
		private DummySerialPort dummySerialPort = new DummySerialPort("/etc/ttyUSB0", 9600, 3000, DataBits.DATABITS_8,
				Parity.EVEN, StopBits.STOPBITS_1, FlowControl.NONE, "");
		private final Map<String, SmlTask> tasks = new HashMap<>();

		private BridgeSmlSerialImpl bridge;

		public MySmlComponent(String id, BridgeSmlSerialImpl bridge, int unitId, DummySerialPort port)
				throws OpenemsException {
			super(id, bridge, unitId, AsymmetricMeter.ChannelId.values(), SymmetricMeter.ChannelId.values(),
					ChannelId.values());
			this.bridge = bridge;
			this.dummySerialPort = port;
		}

		public enum ChannelId implements io.openems.edge.common.channel.ChannelId {
			SERIAL_NUMBER(Doc.of(OpenemsType.STRING)), //
			DEVICE_IDENTIFICATION(Doc.of(OpenemsType.STRING)), //
			CONSUMPTION_ENERGY(Doc.of(OpenemsType.DOUBLE)), //
			CONSUMPTION_ENERGY_TARIF_1(Doc.of(OpenemsType.DOUBLE)),
			CONSUMPTION_ENERGY_TARIF_2(Doc.of(OpenemsType.DOUBLE)), //
			PRODUCTION_ENERGY(Doc.of(OpenemsType.DOUBLE)), //
			PRODUCTION_ENERGY_TARIF_1(Doc.of(OpenemsType.DOUBLE)), //
			PRODUCTION_ENERGY_TARIF_2(Doc.of(OpenemsType.DOUBLE)), //
			TOTAL_POWER(Doc.of(OpenemsType.DOUBLE)), //
			POWER_L1(Doc.of(OpenemsType.DOUBLE)), //
			POWER_L2(Doc.of(OpenemsType.DOUBLE)), //
			POWER_L3(Doc.of(OpenemsType.DOUBLE)), //
			MANUFACTURER_ID(Doc.of(OpenemsType.STRING)), //
			PUBLIC_KEY(Doc.of(OpenemsType.STRING));

			private final Doc doc;

			private ChannelId(Doc doc) {
				this.doc = doc;
			}

			@Override
			public Doc doc() {
				return this.doc;
			}
		}

		@Override
		public SerialPort getSmlConnection() {
			return dummySerialPort;
		}

		@Override
		public void addTask(String sourceId, SmlTask task) {
			this.tasks.put(sourceId, task);
		}

		@Override
		public void removeTask(String sourceId) {
			this.tasks.remove(sourceId);
		}

		@Override
		protected void addChannelDataRecords() {
			try {
				addRecord(ChannelId.SERIAL_NUMBER, "0x01 00 00 00 00 FF"); // 1-0:0.0.1*255
				addRecord(ChannelId.DEVICE_IDENTIFICATION, "0x01 00 01 09 00 FF"); // "1-0:0.0.9*255"
				addRecord(SymmetricMeter.ChannelId.ACTIVE_CONSUMPTION_ENERGY, "0x01 00 01 08 00 FF"); // "1-0:1.8.0*255"
				addRecord(ChannelId.CONSUMPTION_ENERGY_TARIF_1, "0x01 00 01 08 01 FF"); // "1-0:1.8.1*255"
				addRecord(ChannelId.CONSUMPTION_ENERGY_TARIF_2, "0x01 00 01 08 02 FF"); // "1-0:1.8.2*255"
				addRecord(SymmetricMeter.ChannelId.ACTIVE_PRODUCTION_ENERGY, "0x01 00 02 00 00 FF"); // "1-0:2.8.0*255"
				addRecord(ChannelId.PRODUCTION_ENERGY_TARIF_1, "0x01 00 02 00 01 FF"); // "1-0:2.8.1*255"
				addRecord(ChannelId.PRODUCTION_ENERGY_TARIF_2, "0x01 00 02 00 02 FF"); // "1-0:2.8.2*255"
				addRecord(SymmetricMeter.ChannelId.ACTIVE_POWER, "0x01 00 10 07 00 FF"); // "1-0:16.7.0*255"
				addRecord(AsymmetricMeter.ChannelId.ACTIVE_POWER_L1, "0x01 00 10 24 00 FF"); // "1-0:36.7.0*255"
				addRecord(AsymmetricMeter.ChannelId.ACTIVE_POWER_L2, "0x01 00 10 38 00 FF"); // "1-0:56.7.0*255"
				addRecord(AsymmetricMeter.ChannelId.ACTIVE_POWER_L3, "0x01 00 10 4C 00 FF"); // "1-0:76.7.0*255"
				addRecord(ChannelId.MANUFACTURER_ID, "0x81 81 81 82 03 FF"); // "129-129:199.130.3*255"
				addRecord(ChannelId.PUBLIC_KEY, "0x81 81 81 82 05 FF"); // "129-129:199.130.5*255"
			} catch (Exception e) {
				e.printStackTrace();
			}
		}

		@Override
		public MeterType getMeterType() {
			return MeterType.GRID;
		}

		private void addRecord(io.openems.edge.common.channel.ChannelId id, String obisCode)
				throws IllegalArgumentException, Exception {
			this.channelDataRecords.add(new ChannelRecord(this.channel(id), obisCode));
		}
	}
}
