name: Build & Test (Testing Branches)

on:
  push:
    branches:
      - 'testing*'
      - 'testing-*'
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - 'testing*'
      - 'testing-*'

jobs:
  validate-structure:
    name: Validate Project Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check project structure (prepare-commit.sh checks)
        run: |
          echo "# Checking project structure (from tools/prepare-commit.sh)"

          # Check each bundle directory
          for D in io.openems.*; do
            if [ -d "${D}" ]; then
              # Skip non-project directories
              case "${D}" in
                build|cnf|doc|edge|ui|tools) continue ;;
              esac

              # Check for empty/non-project directories
              if [ ! -d "${D}/src" ]; then
                echo "::warning file=${D}::${D} has no src/ directory - might be empty"
                continue
              fi

              # Check for test directory
              if [ ! -d "${D}/test" ]; then
                echo "::warning file=${D}::Missing test/ directory in ${D}"
              elif [ ! -f "${D}/test/.gitignore" ]; then
                echo "::warning file=${D}/test/.gitignore::Missing .gitignore in ${D}/test/"
              fi

              # Check for proper project .gitignore
              if [ -f "${D}/.gitignore" ]; then
                if ! grep -q '/bin_test/' "${D}/.gitignore" || ! grep -q '/generated/' "${D}/.gitignore"; then
                  echo "::warning file=${D}/.gitignore::Incomplete .gitignore in ${D} (missing /bin_test/ or /generated/)"
                fi
              else
                echo "::warning file=${D}/.gitignore::Missing .gitignore in ${D}"
              fi

              # Check for Eclipse encoding settings
              if [ ! -f "${D}/.settings/org.eclipse.core.resources.prefs" ]; then
                echo "::warning file=${D}/.settings/org.eclipse.core.resources.prefs::Missing Eclipse encoding settings in ${D}"
              fi

              # Validate bnd.bnd buildpath is sorted (from prepare-commit.sh lines 119-138)
              if [ -f "${D}/bnd.bnd" ]; then
                start=$(grep -n '${buildpath},' "${D}/bnd.bnd" | grep -Eo '^[^:]+' | head -n1)
                end=$(grep -n 'testpath' "${D}/bnd.bnd" | grep -Eo '^[^:]+' | head -n1)
                if [ -n "$start" -a -n "$end" ]; then
                  # Extract buildpath section and check if sorted
                  buildpath_section=$(head -n$(expr $end - 2) "${D}/bnd.bnd" | tail -n$(expr $end - $start - 2))
                  sorted_buildpath=$(echo "$buildpath_section" | LC_COLLATE=C sort)
                  if [ "$buildpath_section" != "$sorted_buildpath" ]; then
                    echo "::warning file=${D}/bnd.bnd::buildpath in ${D}/bnd.bnd is not sorted alphabetically"
                  fi
                fi
              fi
            fi
          done

  build-java:
    name: Build & Test Java
    runs-on: ubuntu-latest
    needs: validate-structure
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Checkstyle Annotations
        uses: kiancross/checkstyle-annotations-action@v1

      - name: Run Checkstyle
        run: ./gradlew checkstyleAll --console=plain --warn

      - name: Build all Java packages
        run: ./gradlew build --console=plain --warn

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            **/build/test-results/**/*.xml
            **/build/reports/tests/**

      - name: Resolve OpenEMS bundles
        run: |
          echo "Resolving EdgeApp.bndrun..."
          ./gradlew resolve.EdgeApp --console=plain --warn

          echo "Resolving BackendApp.bndrun..."
          ./gradlew resolve.BackendApp --console=plain --warn

      - name: Validate BackendApp.bndrun
        run: |
          if ! git diff --exit-code io.openems.backend.application/BackendApp.bndrun; then
            echo "::warning file=io.openems.backend.application/BackendApp.bndrun::BackendApp.bndrun has changes after resolve"
            git diff io.openems.backend.application/BackendApp.bndrun
          fi

      - name: Validate EdgeApp.bndrun
        run: |
          if ! git diff --exit-code io.openems.edge.application/EdgeApp.bndrun; then
            echo "::warning file=io.openems.edge.application/EdgeApp.bndrun::EdgeApp.bndrun has changes after resolve"
            git diff io.openems.edge.application/EdgeApp.bndrun
          fi

      - name: Upload bndrun files
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bndrun-files
          path: |
            io.openems.backend.application/BackendApp.bndrun
            io.openems.edge.application/EdgeApp.bndrun

      - name: Generate JaCoCo Code-coverage-report
        run: ./gradlew jacocoTestReport jacocoAggregatedReport

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          flags: java
          token: ${{ secrets.CODECOV_TOKEN }}

  build-ui:
    name: Build & Test UI
    runs-on: ubuntu-latest
    needs: validate-structure
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Cache for Node.js
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ~/.ng
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-node-

      - name: Install UI dependencies
        working-directory: ./ui
        run: npm ci --prefer-offline --cache ~/.npm

      - name: Configure Angular Cache
        working-directory: ./ui
        run: node_modules/.bin/ng config cli.cache.path "~/.ng"

      - name: Lint UI with auto-fix (prepare-commit.sh line 189)
        working-directory: ./ui
        run: node_modules/.bin/ng lint --fix
        continue-on-error: true

      - name: TypeScript compilation check
        working-directory: ./ui
        run: node_modules/.bin/tsc --noEmit
        continue-on-error: true

      - name: TypeScript strict check (prepare-commit.sh line 191)
        working-directory: ./ui
        run: |
          if [ -f "node_modules/.bin/tsc-strict" ]; then
            node_modules/.bin/tsc-strict
          else
            echo "::warning::tsc-strict not available, skipping"
          fi
        continue-on-error: true

      - name: Build UI Edge (prepare-commit.sh line 192)
        working-directory: ./ui
        run: node_modules/.bin/ng build -c "openems,openems-edge-prod,prod"

      - name: Build UI Backend (prepare-commit.sh line 192)
        working-directory: ./ui
        run: node_modules/.bin/ng build -c "openems,openems-backend-prod,prod"
        continue-on-error: true

      - name: Test UI
        working-directory: ./ui
        run: |
          export CHROME_BIN=/usr/bin/google-chrome-stable
          npm run test -- --code-coverage --no-watch --no-progress --browsers=ChromeHeadlessCI

      - name: Upload UI Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-test-results
          path: ui/coverage/

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          flags: ui
          directory: ./ui/
          token: ${{ secrets.CODECOV_TOKEN }}
