<div *ngFor="let yearData of tariffData; let yi = index" class="year-section">
    <ion-item lines="full">
        <ion-label class="ion-text-center">
            <h2>{{'FORMLY_FORM.TARIFF_TABLE.TITLE' | translate: {year: YEAR_DATA.YEAR} }}</h2>
            <p>{{ PROPS.DESCRIPTION }}</p>
        </ion-label>
    </ion-item>

    <ion-grid class="tariff-grid">
        <div class="price-items-container">
            <!-- Price Items Header Row (Toggle for tariff price inputs) -->
            <ion-row class="ion-align-items-center tariff-grid-header-row price-items-toggle-row">
                <ion-col size="auto">
                    <ion-button (click)="togglePriceItems = !togglePriceItems" fill="clear" size="small"
                        class="expand-button">
                        <ion-icon slot="icon-only"
                            [name]="togglePriceItems ? 'chevron-down-outline' : 'chevron-forward-outline'">
                        </ion-icon>
                    </ion-button>
                </ion-col>
                <ion-col>
                    {{'FORMLY_FORM.TARIFF_TABLE.PRICE_ITEMS' | translate}}
                </ion-col>
            </ion-row>

            <!-- Price Items Content (Tariff Price Inputs - Conditionally displayed) -->
            <ng-container *ngIf="togglePriceItems">
                <ion-row class="ion-align-items-center tariff-price-row"
                    *ngFor="let tariff of yearData?.tariffs | keyvalue">
                    <ion-col>
                        <ion-input type="number" [value]="YEAR_DATA.TARIFFS[TARIFF.KEY]" labelPlacement="floating"
                            [label]="tariffLabels[TARIFF.KEY] | translate"
                            (ionChange)="updateTariffPrice(yi, TARIFF.KEY, $EVENT.DETAIL.VALUE)" placeholder="0.00"
                            class="tariff-input input-text-right">
                        </ion-input>
                    </ion-col>
                    <ion-col size="auto" class="input-unit">
                        Cent/kWh
                    </ion-col>
                </ion-row>
            </ng-container>
        </div>

        <!-- Quarter Rows -->
        <ion-row *ngFor="let quarterData of YEAR_DATA.QUARTERS; let qi = index; trackBy: trackByQuarterKey"
            class="quarter-row">
            <ng-container *ngIf="quarterData">
                <ion-col (click)="toggleQuarterVisibilityByKey(QUARTER_DATA.KEY!)" class="quarter-label-col" size="12">
                    <ion-button fill="clear" size="small" class="expand-button">
                        <ion-icon slot="icon-only"
                            [name]="isQuarterExpandedByKey(QUARTER_DATA.KEY!) ? 'chevron-down-outline' : 'chevron-forward-outline'">
                        </ion-icon>
                    </ion-button>
                    Q{{ QUARTER_DATA.QUARTER }} - {{ QUARTER_DATA.FORMATTED_DATE_RANGE }}
                </ion-col>

                <ion-col size="12" class="quarter-details-col" *ngIf="isQuarterExpandedByKey(QUARTER_DATA.KEY!)">
                    <!-- Low Tariff Schedules -->
                    <div class="tariff-section">
                        <h4>{{ 'FORMLY_FORM.TARIFF_TABLE.TARIFFS.LOW' | translate }} (NT)</h4>
                        <div *ngFor="let schedule of QUARTER_DATA.LOW_SCHEDULES; trackBy: trackByScheduleOriginalIndex"
                            class="time-range-row">
                            <oe-pick-date-time-range [mode]="'time'" [displayValue]="SCHEDULE.FROM | timedisplay"
                                [minuteValues]="'0,15,30,45'" [invalid]="isTimeRangeInvalid(schedule)"
                                (timeChange)="updateTimeRange(yi, qi, SCHEDULE.ORIGINAL_INDEX!, 'from', $event)"
                                class="ion-padding time-input">
                            </oe-pick-date-time-range>
                            <span class="time-separator">&nbsp;–&nbsp;</span>
                            <oe-pick-date-time-range [mode]="'time'" [displayValue]="SCHEDULE.TO | timedisplay"
                                [minuteValues]="'0,15,30,45'" [invalid]="isTimeRangeInvalid(schedule)"
                                (timeChange)="updateTimeRange(yi, qi, SCHEDULE.ORIGINAL_INDEX!, 'to', $event)"
                                class="ion-padding time-input">
                            </oe-pick-date-time-range>
                            <ion-button fill="clear" size="small" class="remove-time-btn"
                                (click)="removeTimeRange(yi, qi, SCHEDULE.ORIGINAL_INDEX!)">
                                <ion-icon name="trash-outline" slot="icon-only" color="danger"></ion-icon>
                            </ion-button>
                        </div>
                        <ion-button fill="outline" size="small" class="add-time-btn"
                            (click)="addTimeRange(yi, qi, 'low')">
                            <ion-icon name="add-circle-outline" slot="start"> </ion-icon>
                            {{ 'FORMLY_FORM.TARIFF_TABLE.ADD_TIME_SLOT' | translate }}
                        </ion-button>
                    </div>

                    <!-- High Tariff Schedules -->
                    <div class="tariff-section">
                        <h4>{{ 'FORMLY_FORM.TARIFF_TABLE.TARIFFS.HIGH' | translate }} (HT)</h4>
                        <div *ngFor="let schedule of QUARTER_DATA.HIGH_SCHEDULES; trackBy: trackByScheduleOriginalIndex"
                            class="time-range-row">
                            <oe-pick-date-time-range [mode]="'time'" [displayValue]="SCHEDULE.FROM | timedisplay"
                                [minuteValues]="'0,15,30,45'" [invalid]="isTimeRangeInvalid(schedule)"
                                (timeChange)="updateTimeRange(yi, qi, SCHEDULE.ORIGINAL_INDEX!, 'from', $event)"
                                class="ion-padding time-input">
                            </oe-pick-date-time-range>
                            <span class="time-separator">&nbsp;–&nbsp;</span>
                            <oe-pick-date-time-range [mode]="'time'" [displayValue]="SCHEDULE.TO | timedisplay"
                                [minuteValues]="'0,15,30,45'" [invalid]="isTimeRangeInvalid(schedule)"
                                (timeChange)="updateTimeRange(yi, qi, SCHEDULE.ORIGINAL_INDEX!, 'to', $event)"
                                class="ion-padding time-input">
                            </oe-pick-date-time-range>
                            <ion-button fill="clear" size="small" class="remove-time-btn"
                                (click)="removeTimeRange(yi, qi, SCHEDULE.ORIGINAL_INDEX!)">
                                <ion-icon name="trash-outline" slot="icon-only" color="danger"></ion-icon>
                            </ion-button>
                        </div>
                        <ion-button fill="outline" size="small" class="add-time-btn"
                            (click)="addTimeRange(yi, qi, 'high')">
                            <ion-icon name="add-circle-outline" slot="start"> </ion-icon>
                            {{ 'FORMLY_FORM.TARIFF_TABLE.ADD_TIME_SLOT' | translate }}
                        </ion-button>
                    </div>
                </ion-col>
            </ng-container>
        </ion-row>
    </ion-grid>

    <!-- Year Actions (Add/Remove Year Buttons) -->
    <div class="year-actions">
        <ion-toolbar>
            <ion-buttons slot="start">
                <ion-button *ngIf="TARIFF_DATA.LENGTH > 1" fill="clear" color="danger" (click)="removeYear(yi)">
                    {{ 'FORMLY_FORM.TARIFF_TABLE.REMOVE_YEAR' | translate: { year: YEAR_DATA.YEAR } }}
                </ion-button>
                <ion-button *ngIf="!(TARIFF_DATA.LENGTH > 1)" fill="clear" color="success" (click)="addYear()">
                    {{ 'FORMLY_FORM.TARIFF_TABLE.ADD_YEAR' | translate: { year: YEAR_DATA.YEAR + 1 } }}
                </ion-button>
            </ion-buttons>
        </ion-toolbar>
    </div>
</div>

<!-- Hidden form control for Formly integration -->
<input type="hidden" [formControl]="formControl" />
