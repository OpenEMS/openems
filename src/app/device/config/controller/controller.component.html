<div *ngIf="form" [formGroup]="form">
    <div formGroupName="scheduler">
        <div formArrayName="controllers">
            <div *ngFor="let controller of form.controls.scheduler.controls['controllers'].controls, let i=index" fxFlex="100%" [formGroupName]="i">
                <!--existing controller-->
                <div *ngFor="let controllerMeta of form.value._meta['availableControllers'], let j=index">
                    <div fxLayout fxLayoutWrap="wrap" fxFlex *ngIf="controllerMeta.class == controller.value.class && controller.value.id != ''">
                        <md-card class="single" fxFlex="100%">
                            <md-card-header>
                                <md-icon md-card-avatar>apps</md-icon>
                                <md-card-title>
                                    {{ controllerMeta.class | classname }}
                                </md-card-title>
                                <md-card-subtitle>
                                    {{ controller.value.id }}
                                </md-card-subtitle>
                            </md-card-header>
                            <md-card-content style="margin: 20px">
                                <div fxLayout fxLayoutWrap="wrap">
                                    <md-input-container fxFlex="50%">
                                        <input placeholder="PrioritÃ¤t" formControlName="priority" type="number" mdInput>
                                    </md-input-container>
                                </div>
                                <div style="margin-top: 20px" *ngFor="let channelMeta of controllerMeta.channels">
                                    <div *ngIf="channelMeta.name != 'rtc' && channelMeta.name != 'priority'">
                                        <div *ngIf="channelMeta.array" [formArrayName]="channelMeta.name">
                                            <div fxLayout fxLayoutWrap="wrap">
                                                <div *ngFor="let channelChannelMeta of controller.value[channelMeta.name], let k=index">
                                                    <md-select placeholder="{{ channelMeta.type }}" [formControlName]="k" fxFlex.gt="33%" fxFlex.xs="100%">
                                                        <ng-container *ngFor="let nature of form.value._meta['natures'] | keys">
                                                            <ng-container *ngFor="let natureImplement of nature.value.implements">
                                                                <md-option *ngIf="natureImplement == channelMeta.type + 'Nature'" [value]="nature.key">{{ nature.key }}</md-option>
                                                            </ng-container>
                                                        </ng-container>
                                                    </md-select>
                                                    <button (click)="deleteChannel(k, controller.controls[channelMeta.name])" md-mini-fab>
                                                        <md-icon>delete</md-icon>
                                                    </button>
                                                </div>
                                                <button (click)="add(controller.controls[channelMeta.name])" md-mini-fab>
                                                    <md-icon>add</md-icon>
                                                </button>
                                            </div>
                                        </div>
                                        <div *ngIf="!channelMeta.array" fxLayout fxLayoutWrap="wrap">
                                            <md-input-container fxFlex="50%">
                                                <input placeholder="{{ channelMeta.title }}" [formControlName]="channelMeta.name" type="text" mdInput>
                                            </md-input-container>
                                        </div>
                                    </div>
                                </div>
                                <div style="position: absolute;bottom: 0;right: 0; margin: 20px">
                                    <button (click)="save(controller)" [disabled]="form.pristine" color="primary" md-mini-fab>
                                        <md-icon>save</md-icon>
                                    </button>
                                    <button (click)="delete(form.controls.scheduler.controls['controllers'], i)" color="primary" md-mini-fab>
                                        <md-icon>delete</md-icon>
                                    </button>
                                </div>
                            </md-card-content>
                        </md-card>
                    </div>
                </div>
                <!--New controller-->
                <div *ngIf="controller.value.class == '' || controller.value.id == ''">
                    <md-card class="single">
                        <md-card-header>
                            <md-icon md-card-avatar>stop</md-icon>
                            <label>Neuer Controller...</label>
                        </md-card-header>
                        <md-card-content>
                            <div fxLayout fxLayoutWrap="wrap" style="margin-bottom: 20px">
                                <md-input-container>
                                    <input placeholder="Name" formControlName="id" type="text" mdInput>
                                </md-input-container>
                                <button [disabled]="form.pristine" (click)="setNameReady()" md-mini-fab>
                                    <md-icon>send</md-icon>
                                </button>
                            </div>
                            <div *ngIf="nameReady" fxLayout fxLayoutWrap="wrap">
                                <label>Klasse: </label>
                                <select fxFlex="50%" formControlName="class" (change)="addChannelsToController(controller, controller.value.class)">
                                    <option></option>
                                    <option *ngFor="let availableControllers of form.value._meta['availableControllers']">
                                        {{ availableControllers.class }}
                                    </option>
                                </select>
                            </div>
                        </md-card-content>
                    </md-card>
                </div>
            </div>
            <md-card class="single_leftright">
                <md-card-header>
                    <md-icon md-card-avatar>stop</md-icon>
                    <label>Neuer Controller...</label>
                </md-card-header>
                <md-card-content>
                    <div fxLayout fxLayoutAlign="end start">
                        <button (click)="addController(form.controls.scheduler.controls['controllers'])" md-mini-fab>
                            <md-icon>add</md-icon>
                        </button>
                    </div>
                </md-card-content>
            </md-card>
        </div>
    </div>
</div>